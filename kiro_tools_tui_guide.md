# Kiro Gateway 工具集 - 整合 TUI 版本使用指南

## 简介

`kiro_tools_tui.py` 是一个整合的终端用户界面（TUI）工具，将 Token 转换和认证切换两个功能集成到一个应用中，提供统一的用户体验。

## 功能特性

✨ **核心功能：**
- 🏠 主菜单导航 - 快速切换功能模块
- 🔐 Token 转换工具 - 管理和转换 Kiro token
- 🔄 认证切换工具 - 快速切换认证方式
- ⌨️ 完整的键盘快捷键支持
- 🎨 统一的美观界面

## 安装依赖

```bash
pip install textual cbor2 requests
```

或使用项目的 requirements.txt：

```bash
pip install -r requirements.txt
```

## 使用方法

### 启动应用

```bash
python3 kiro_tools_tui.py
```

或直接执行：

```bash
./kiro_tools_tui.py
```

### 主菜单

应用启动后，你会看到主菜单：

```
┌─────────────────────────────────────────────────────────────┐
│                  🔐 Kiro Gateway 工具集                      │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  [1️⃣  Token 转换工具]                                        │
│                                                              │
│  [2️⃣  认证切换工具]                                          │
│                                                              │
│  [❌ 退出 (Q)]                                               │
│                                                              │
├─────────────────────────────────────────────────────────────┤
│        💡 提示: 使用数字键或点击按钮选择功能                  │
└─────────────────────────────────────────────────────────────┘
```

**主菜单快捷键：**
- `1` - 进入 Token 转换工具
- `2` - 进入认证切换工具
- `Q` - 退出应用

### 功能模块 1: Token 转换工具

#### 进入方式
- 在主菜单按 `1` 或点击"Token 转换工具"按钮

#### 界面说明

```
┌─────────────────────────────────────────────────────────────┐
│ 🔐 Token 转换工具                                            │
├─────────────────────────────────────────────────────────────┤
│ 源文件: tokens_export.json → 目标文件: kiro-credentials.json│
├─────────────────────────────────────────────────────────────┤
│ 序号 │ 状态      │ 邮箱              │ 过期时间          │...│
│  1   │ ✅ 有效   │ user@example.com  │ 2026-02-08 10:00 │...│
│  2   │ ❌ 已过期 │ test@example.com  │ 2026-01-01 12:00 │...│
├─────────────────────────────────────────────────────────────┤
│ 选中的 Token 详情:                                           │
│ 📧 邮箱: user@example.com                                    │
│ ⏰ 过期时间: 2026-02-08T10:00:00+00:00                      │
│ 💳 使用限额: 1000/5000 (剩余: 4000)                         │
├─────────────────────────────────────────────────────────────┤
│ [刷新 Token (R)] [转换并保存 (C)] [返回 (ESC)]              │
└─────────────────────────────────────────────────────────────┘
```

#### 快捷键

| 快捷键 | 功能 |
|--------|------|
| `↑` / `↓` | 在 token 列表中上下移动 |
| `R` | 刷新选中的 token |
| `C` | 转换并保存选中的 token |
| `ESC` | 返回主菜单 |

#### 操作流程

1. **选择 Token**
   - 使用 `↑` / `↓` 方向键选择要操作的 token
   - 选中后，下方会显示该 token 的详细信息

2. **刷新 Token（可选）**
   - 按 `R` 键
   - 在确认对话框中按 `Y` 确认
   - 应用会自动刷新 token 并更新使用限额

3. **转换并保存**
   - 按 `C` 键
   - 在确认对话框中按 `Y` 确认
   - Token 将被转换并保存到 `kiro-credentials.json`

4. **返回主菜单**
   - 按 `ESC` 键

### 功能模块 2: 认证切换工具

#### 进入方式
- 在主菜单按 `2` 或点击"认证切换工具"按钮

#### 界面说明

```
┌─────────────────────────────────────────────────────────────┐
│ 🔐 认证方式切换工具                                          │
├─────────────────────────────────────────────────────────────┤
│ 📊 当前认证方式                                              │
│ 🔑 REFRESH_TOKEN (刷新令牌)                                  │
│ 值: aorAAAAAGnsuOUfb1872VvfjVZxp...                         │
├─────────────────────────────────────────────────────────────┤
│ 🔄 选择新的认证方式                                          │
│ ● 📁 KIRO_CREDS_FILE - Kiro IDE 凭证文件                    │
│ ○ 🔑 REFRESH_TOKEN - 刷新令牌                                │
│ ○ 💾 KIRO_CLI_DB_FILE - kiro-cli SQLite 数据库              │
├─────────────────────────────────────────────────────────────┤
│ 📝 配置值                                                    │
│ [./kiro-credentials.json                                   ]│
│ 💡 示例: ./kiro-credentials.json                            │
├─────────────────────────────────────────────────────────────┤
│ [切换认证 (S)] [返回 (ESC)]                                  │
├─────────────────────────────────────────────────────────────┤
│ 💡 提示: 切换后其他认证方式将自动注释，需重启服务生效        │
└─────────────────────────────────────────────────────────────┘
```

#### 快捷键

| 快捷键 | 功能 |
|--------|------|
| `↑` / `↓` | 在单选按钮间移动 |
| `Space` | 选择单选按钮 |
| `Tab` | 在控件间切换焦点 |
| `S` | 执行切换认证 |
| `ESC` | 返回主菜单 |

#### 操作流程

1. **查看当前认证方式**
   - 顶部显示当前正在使用的认证方式

2. **选择新的认证方式**
   - 使用 `↑` / `↓` 方向键移动，按 `Space` 选择
   - 或直接点击单选按钮

3. **输入配置值**
   - 在输入框中输入或修改配置值
   - 应用会自动填充默认值

4. **执行切换**
   - 按 `S` 键或点击"切换认证"按钮
   - 应用会自动更新 `.env` 文件

5. **返回主菜单**
   - 按 `ESC` 键

## 完整工作流程示例

### 场景 1: 刷新并转换 Token

```bash
# 1. 启动应用
./kiro_tools_tui.py

# 2. 在主菜单按 1 进入 Token 转换工具

# 3. 使用方向键选择要刷新的 token

# 4. 按 R 刷新 token
#    - 按 Y 确认
#    - 等待刷新完成

# 5. 按 C 转换并保存
#    - 按 Y 确认
#    - 查看成功消息

# 6. 按 ESC 返回主菜单

# 7. 按 Q 退出应用
```

### 场景 2: 切换认证方式

```bash
# 1. 启动应用
./kiro_tools_tui.py

# 2. 在主菜单按 2 进入认证切换工具

# 3. 查看当前认证方式

# 4. 选择新的认证方式
#    - 使用方向键移动到目标选项
#    - 按 Space 选择

# 5. 输入配置值
#    - Tab 切换到输入框
#    - 输入或修改配置值

# 6. 按 S 执行切换
#    - 查看成功消息

# 7. 重启服务
#    sudo systemctl restart kiro-gateway

# 8. 按 ESC 返回主菜单

# 9. 按 Q 退出应用
```

## 与独立工具的对比

| 特性 | 独立工具 | 整合工具 |
|------|---------|---------|
| 应用数量 | 2 个独立应用 | 1 个统一应用 |
| 启动方式 | 分别启动 | 主菜单选择 |
| 界面风格 | 各自独立 | 统一设计 |
| 功能切换 | 退出重启 | 返回主菜单 |
| 用户体验 | 基础 | 更流畅 |
| 维护成本 | 较高 | 较低 |

## 优势

### 1. 统一入口
- 一个命令启动所有工具
- 主菜单快速导航
- 减少记忆负担

### 2. 一致体验
- 统一的界面设计
- 相同的操作逻辑
- 标准化的快捷键

### 3. 便捷切换
- 无需退出应用
- 快速切换功能
- 保持工作流连续性

### 4. 易于维护
- 单一代码库
- 共享组件和样式
- 统一的依赖管理

## 技术架构

### 应用结构

```
KiroToolsApp (主应用)
├── MainMenuScreen (主菜单)
├── TokenConverterScreen (Token 转换)
├── AuthSwitcherScreen (认证切换)
└── 共享组件
    ├── StatusScreen (状态对话框)
    └── ConfirmScreen (确认对话框)
```

### 核心模块

1. **Token 处理模块**
   - `parse_datetime()` - 日期解析
   - `get_valid_tokens()` - Token 验证
   - `refresh_token()` - Token 刷新
   - `get_usage_limit()` - 使用限额查询
   - `convert_token()` - 格式转换

2. **认证切换模块**
   - `AuthSwitcher` 类
   - `.env` 文件读写
   - 认证方式检测和切换

3. **UI 组件**
   - 屏幕管理
   - 对话框系统
   - 快捷键绑定

## 故障排除

### 问题：应用无法启动

**解决方案：**
```bash
# 检查依赖
pip install textual cbor2 requests

# 检查 Python 版本
python3 --version  # 需要 3.7+

# 检查文件权限
chmod +x kiro_tools_tui.py
```

### 问题：Token 转换功能报错

**可能原因：**
- `tokens_export.json` 文件不存在
- 文件格式错误
- 没有有效的 token

**解决方案：**
```bash
# 检查文件是否存在
ls -la tokens_export.json

# 验证 JSON 格式
python3 -m json.tool tokens_export.json
```

### 问题：认证切换功能报错

**可能原因：**
- `.env` 文件不存在
- 文件权限不足
- 文件格式不正确

**解决方案：**
```bash
# 检查文件是否存在
ls -la .env

# 检查文件权限
chmod 644 .env

# 备份并重新创建
cp .env .env.backup
```

## 最佳实践

### 1. 定期备份

```bash
# 备份重要文件
cp tokens_export.json tokens_export.json.backup
cp .env .env.backup
cp kiro-credentials.json kiro-credentials.json.backup
```

### 2. 工作流建议

- 先刷新 token，再转换保存
- 切换认证后立即重启服务
- 定期检查 token 过期时间

### 3. 安全性

- 不要分享 token 和凭证文件
- 定期轮换认证凭证
- 确保敏感文件已添加到 `.gitignore`

## 开发信息

- **文件名**: `kiro_tools_tui.py`
- **大小**: 32KB
- **行数**: 1005 行
- **语言**: Python 3.7+
- **UI 框架**: Textual
- **依赖**: textual, cbor2, requests

## 相关文件

- `convert_tokens_tui.py` - Token 转换工具（独立版本）
- `switch_auth_tui.py` - 认证切换工具（独立版本）
- `convert_tokens.py` - Token 转换工具（命令行版本）
- `switch_auth.py` - 认证切换工具（命令行版本）

## 反馈与贡献

如有问题或建议，请提交 Issue 或 Pull Request。

---

**提示：** 整合版本提供更好的用户体验，推荐使用此版本替代独立工具。
